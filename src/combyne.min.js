/* combyne.js v0.1.2
 * Copyright 2011, Tim Branyen (@tbranyen)
 * combyne.js may be freely distributed under the MIT license.
 */(function(a){function g(a){var b=this,c;return function(){c=c?c:{original:b.template};return a.apply(c,arguments)}}function f(a,b){function c(){return{_cache:{},get:function(a){return this._cache[a]},remove:function(a){delete this._cache[a]}}}if(!(this instanceof f))return new f(a,b);this.template=a,this.context=b||{},this.filters=c(),this.filters.add=function(a,b){this._cache[a]=g(b)},this.partials=c(),this.partials.add=function(a,b,c){this._cache[a]={template:b,context:c}}}function b(a,b){function e(){}var c,d;e.prototype=b,c=new e;for(d in a){if(!a.hasOwnProperty(d))continue;c[d]=a[d]}return c}var c=function(){var a;return function(b,c,d){a=d=d||a;var e,f,g,h=Object.keys(d),i=h.length,j=0;while(b.length)for(j=0;j<i;j++){g=h[j];if(e=d[g].exec(b))f={name:g,captures:e},b=b.replace(d[g],""),e[0]&&c.push(f)}}}(),d=function(){function n(a,b,e,f,i){var j,k,l,m=[],n=e[0],o=a.partials.get(n);if(o==null&&a.debug)throw new Error("Partial "+n+" not found");if(error=c(o.template,m))if(a.debug)throw new Error(error);m.reverse(),j=h,k=i.get(),h="",i.clear(),l=d(a,o.context,m,g),h=j,i.set(k),i.unset("skip");return l}function m(a,b,c,d){var e,f,g,h,i,k,l=b.length,m=!0,n={"==":function(a,b){if(a==b)return!0;return!1},"!=":function(a,b){if(a!=b)return!0;return!1},">":function(a,b){if(a>b)return!0;return!1},">=":function(a,b){if(this["=="](a,b)||this[">"](a,b))return!0;return!1},"<":function(a,b){if(a<b)return!0;return!1},"<=":function(a,b){if(this["=="](a,b)||this["<"](a,b))return!0;return!1},not:function(a){return!a}};for(e=0;e<l;e++){f=isNaN(b[e])?b[e]+"":+b[e];if(f==="not"){k=!0;continue}if(n[f]){i=f;continue}f=j(f,c);if(k){k=undefined;if(g===undefined){g=n.not(f);continue}h=f;continue}if(g===undefined){g=f;continue}h=f;break}i?n[i]?m=n[i](g,h):m=!1:m=g;return m}function l(a,b){function d(a){var b,e=c.shift();b=a[e];if(b!=null)return c.length?d(b):b}var c=a.split(".");if(c.length)return d(b)}function k(a,b,c,d,e,f){var g,h,i=a.filters.get(b);if(i==null){i=function(){return d};if(a.debug)throw new Error("Filter "+b+" not found")}for(g=0,h=c.length;g<h;g++)c[g]=j(c[g],e);c.unshift(d),f.unset("filter");return i.apply(d,c)}function j(a,b){var c=/\'|\"/gi;c.exec(a)?a=a.replace(c,""):isNaN(a)?typeof a=="string"&&(a=b[a]!=null?b[a]:l(a,b),typeof a=="function"&&(a=a()),typeof a!="boolean"&&typeof a!="number"&&a!=null&&(a=a+"")):a=+a;return a}var a,e,f,g,h="",i="",o=function(){var a=[];return{set:function(b){a=a.concat(b)},get:function(){return a},unset:function(b){a.splice(a.indexOf(b),1)},exists:function(b){return~a.indexOf(b)},clear:function(){a=[]},count:function(b){var c,d;for(c=d=0;~(d=a.indexOf(b,d));c++);return c}}}(),p=function(){var a,f,i,j,k,l,m=[];return{execArray:function(f,i,m,n){var p,q;a=o.get(),o.unset("loop");if(i&&i.length)for(p=0,q=i.length;p<q;p++){j=[];if(k=c(e,j))if(f.debug)throw new Error(k);j.reverse(),l={i:p,length:q,original:i},l[m.index||"."]=i[p],typeof i[p]=="object"?(l=b(l,i[p]),i[p]=b(i[p],n)):l=b(l,n),h=d(f,l,j,g)}o.set(a),e=h},execObj:function(m,n,p,q){var r,s;a=o.get(),o.unset("loop"),i=n?Object.keys(n):[];if(i.length)for(r=0,s=i.length;r<s;r++){f=i[r],j=[];if(k=c(e,j))if(m.debug)throw new Error(k);j.reverse(),l={original:n},l[p.key||"."]=f,l[p.obj||"original"]=n,l[p.val||"$"]=n[f],typeof n[f]=="object"?(l=b(l,n[f]),n[f]=b(n[f],q)):l=b(l,q),h=d(m,l,j,g)}o.set(a)},clear:function(){m=[]}}}();return function(b,c,l,q){var r,s,t,u=l.pop(),v=u.captures[0];g=q||g;switch(u.name){case"START_PROP":if(o.exists("skip"))break;if(o.exists("loop")){e+=v;break}o.set("prop");break;case"END_PROP":if(o.exists("skip"))break;if(o.exists("loop")){e+=v;break}typeof a!="object"?h+=a:h+=q.START_PROP+a.prop+q.END_PROP,o.unset("prop");break;case"START_EXPR":o.set("expr");if(o.exists("skip"))break;o.exists("loop")&&(e+=v);break;case"END_EXPR":o.unset("expr");if(o.exists("skip")){a==="--"&&o.unset("skip");break}o.exists("loop")&&(e+=v),o.exists("partial")&&(h+=a,o.unset("partial")),a==="endeach"&&o.unset("loop");break;case"OTHER":if(o.exists("prop")){if(o.exists("skip"))break;if(o.exists("loop")){e+=v;break}a=j(v,c),a==null&&(a={prop:v})}else if(o.exists("filter")){if(o.exists("skip"))break;if(o.exists("loop")){e+=v;break}r=v.split(" "),s=r.shift(),t=r,a=k(b,s,t,a,c,o),o.set("string")}else if(o.exists("expr")){r=v.split(" "),s=r.shift(),t=r;if(s==="if"||s==="elsif"){if(!o.exists("else")&&o.exists("skip"))break;o.exists("else")&&o.unset("else");if(o.exists("loop")){e+=v;break}if(t.length<1){if(b.debug)throw new Error("No arguments supplied for if statement")}else if(t.length===1){if(!j(t[0],c)){o.set("else"),o.set("skip");break}}else m(b,t,c)?o.unset("skip"):(o.set("else"),o.set("skip"))}else if(s==="else")o.exists("else")?o.unset("skip"):o.exists("skip")||o.set("skip");else if(s==="endif"){if(o.exists("loop")){e+=v;break}o.unset("skip")}else if(s==="each"){if(o.exists("skip"))break;if(o.exists("loop")){o.set("loop"),e+=v;break}o.set("loop");if(t.length<1){if(b.debug)throw new Error("No arguments supplied for each statement")}else Array.isArray(c[t[0]])?(f={},a=c[t[0]],f.index=t[2],e=""):(f={},c[t[0]]&&(a=c[t[0]],f.obj=t[0],f.key=t[2],f.val=t[3],e=""))}else if(s==="endeach"){if(o.exists("skip"))break;o.unset("loop");if(!o.exists("loop"))Array.isArray(a)?p.execArray(b,a,f,c):p.execObj(b,a,f,c),p.clear();else if(o.exists("loop")){e+=v+q.END_EXPR;break}}else if(s==="partial"){if(o.exists("skip"))break;if(o.exists("loop")){e+=v;break}r=v.split(" "),s=r.shift(),t=r,a=n(b,s,t,a,o),o.set("partial"),o.set("expr")}}else{if(o.exists("skip"))break;if(o.exists("loop")){e+=v;break}h+=v}break;case"WHITESPACE":if(o.exists("skip"))break;if(o.exists("loop")){e+=v;break}h+=v;break;case"FILTER":if(o.exists("skip"))break;if(o.exists("loop")){e+=v;break}o.unset("prop"),o.set("filter");break;case"COMMENT":if(o.exists("skip")){a="--";break}if(o.exists("loop")){e+=v;break}o.exists("expr")?o.set("skip"):h+=q.COMMENT}if(l.length)return d(b,c,l,q);i=h,o.clear(),h="",a=undefined;return i}}(),e=function(){function b(b){return b.replace(a,"\\$&")}var a=/[\^$\\\/.*+?()[\]{}|]/g;return function(a,e,f,g){var h,i,j,k,l,m,n,o=0,p=[],q={};i=b(g.START_PROP),j=b(g.END_PROP),k=b(g.START_EXPR),l=b(g.END_EXPR),m=b(g.COMMENT),n=b(g.FILTER),q.START_PROP=RegExp("^"+i),q.END_PROP=RegExp("^"+j),q.START_EXPR=RegExp("^"+k),q.END_EXPR=RegExp("^"+l),q.COMMENT=RegExp("^"+m),q.FILTER=RegExp("^"+n),h=[i,j,k,l,m,n].join("|"),q.WHITESPACE=/^[\ |\t|\r|\n]+/,q.OTHER=RegExp("^((?!"+h+").)*");if(o=c(e,p,q))if(a.debug)throw new Error(o);p.reverse();return d(a,f,p,g)}}();f.version="0.1.3",f.prototype={render:function(){var a=this;if(!a.template||!a.context)if(a.debug)throw new Error("Missing template or context");a.delimiters=a.delimiters||{},a.delimiters=b(a.delimiters,{START_PROP:"{{",END_PROP:"}}",START_EXPR:"{%",END_EXPR:"%}",COMMENT:"--",FILTER:"|"});return e(a,a.template,a.context,a.delimiters)},delimiters:{}},typeof module!="undefined"&&module.exports?(module.exports=f,module.exports.compile=function(a){return function(b){return f(a,b).render()}}):a.combyne=f})(this)