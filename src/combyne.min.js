/* combyne.js v0.1.2
 * Copyright 2011, Tim Branyen (@tbranyen)
 * combyne.js may be freely distributed under the MIT license.
 */(function(a){function h(a){var b=this,c;return function(){c=c?c:{original:b.template};return a.apply(c,arguments)}}function g(a,b){function c(){return{_cache:{},get:function(a){return this._cache[a]},remove:function(a){delete this._cache[a]}}}if(!(this instanceof g))return new g(a,b);this.template=a,this.context=b||{},this.filters=c(),this.filters.add=function(a,b){this._cache[a]=h(b)},this.partials=c(),this.partials.add=function(a,b,c){this._cache[a]={template:b,context:c}}}function c(a){var b,c=[];for(b in a){if(!a.hasOwnProperty(b))continue;c.push(b)}return c}function b(a,b){function e(){}var c,d;e.prototype=b,c=new e;for(d in a){if(!a.hasOwnProperty(d))continue;c[d]=a[d]}return c}var d=function(){var a;return function(b,d,e){a=e=e||a;var f,g,h,i=c(e),j=i.length,k=0;while(b.length)for(k=0;k<j;k++){h=i[k];if(f=e[h].exec(b))g={name:h,captures:f},b=b.replace(e[h],""),f[0]&&d.push(g)}}}(),e=function(){function o(a,b,c,f,g){var j,k,l,m=[],n=c[0],o=a.partials.get(n);if(o==null&&a.debug)throw new Error("Partial "+n+" not found");if(error=d(o.template,m))if(a.debug)throw new Error(error);m.reverse(),j=i,k=g.get(),i="",g.clear(),l=e(a,o.context,m,h),i=j,g.set(k),g.unset("skip");return l}function n(a,b,c,d){var e,f,g,h,i,j,l=b.length,m=!0,n={"==":function(a,b){if(a==b)return!0;return!1},"!=":function(a,b){if(a!=b)return!0;return!1},">":function(a,b){if(a>b)return!0;return!1},">=":function(a,b){if(this["=="](a,b)||this[">"](a,b))return!0;return!1},"<":function(a,b){if(a<b)return!0;return!1},"<=":function(a,b){if(this["=="](a,b)||this["<"](a,b))return!0;return!1},not:function(a){return!a}};for(e=0;e<l;e++){f=isNaN(b[e])?b[e]+"":+b[e];if(f==="not"){j=!0;continue}if(n[f]){i=f;continue}f=k(f,c);if(j){j=undefined;if(g===undefined){g=n.not(f);continue}h=f;continue}if(g===undefined){g=f;continue}h=f;break}i?n[i]?m=n[i](g,h):m=!1:m=g;return m}function m(a,b){function d(a){var b,e=c.shift();b=a[e];if(b!=null)return c.length?d(b):b}var c=a.split(".");if(c.length)return d(b)}function l(a,b,c,d,e,f){var g,h,i=a.filters.get(b);if(i==null){i=function(){return d};if(a.debug)throw new Error("Filter "+b+" not found")}for(g=0,h=c.length;g<h;g++)c[g]=k(c[g],e);c.unshift(d),f.unset("filter");return i.apply(d,c)}function k(a,b){var c=/\'|\"/gi;c.exec(a)?a=a.replace(c,""):isNaN(a)?typeof a=="string"&&(a=b[a]!=null?b[a]:m(a,b),typeof a=="function"&&(a=a()),typeof a!="boolean"&&typeof a!="number"&&a!=null&&(a=a+"")):a=+a;return a}var a,f,g,h,i="",j="",p=function(){var a=[];return{set:function(b){a=a.concat(b)},get:function(){return a},unset:function(b){a.splice(a.indexOf(b),1)},exists:function(b){return~a.indexOf(b)},clear:function(){a=[]},count:function(b){var c,d;for(c=d=0;~(d=a.indexOf(b,d));c++);return c}}}(),q=function(){var a,g,j,k,l,m,n=[];return{execArray:function(c,g,j,n){var o,q;a=p.get(),p.unset("loop");if(g&&g.length)for(o=0,q=g.length;o<q;o++){k=[];if(l=d(f,k))if(c.debug)throw new Error(l);k.reverse(),m={i:o,length:q,original:g},m[j.index||"."]=g[o],typeof g[o]=="object"?(m=b(m,g[o]),g[o]=b(g[o],n)):m=b(m,n),i=e(c,m,k,h)}p.set(a),f=i},execObj:function(n,o,q,r){var s,t;a=p.get(),p.unset("loop"),j=o?c(o):[];if(j.length)for(s=0,t=j.length;s<t;s++){g=j[s],k=[];if(l=d(f,k))if(n.debug)throw new Error(l);k.reverse(),m={original:o},m[q.key||"."]=g,m[q.obj||"original"]=o,m[q.val||"$"]=o[g],typeof o[g]=="object"?(m=b(m,o[g]),o[g]=b(o[g],r)):m=b(m,r),i=e(n,m,k,h)}p.set(a)},clear:function(){n=[]}}}();return function(b,c,d,m){var r,s,t,u=d.pop(),v=u.captures[0];h=m||h;switch(u.name){case"START_PROP":if(p.exists("skip"))break;if(p.exists("loop")){f+=v;break}p.set("prop");break;case"END_PROP":if(p.exists("skip"))break;if(p.exists("loop")){f+=v;break}typeof a!="object"?i+=a:i+=m.START_PROP+a.prop+m.END_PROP,p.unset("prop");break;case"START_EXPR":p.set("expr");if(p.exists("skip"))break;p.exists("loop")&&(f+=v);break;case"END_EXPR":p.unset("expr");if(p.exists("skip")){a==="--"&&p.unset("skip");break}p.exists("loop")&&(f+=v),p.exists("partial")&&(i+=a,p.unset("partial")),a==="endeach"&&p.unset("loop");break;case"OTHER":if(p.exists("prop")){if(p.exists("skip"))break;if(p.exists("loop")){f+=v;break}a=k(v,c),a==null&&(a={prop:v})}else if(p.exists("filter")){if(p.exists("skip"))break;if(p.exists("loop")){f+=v;break}r=v.split(" "),s=r.shift(),t=r,a=l(b,s,t,a,c,p),p.set("string")}else if(p.exists("expr")){r=v.split(" "),s=r.shift(),t=r;if(s==="if"||s==="elsif"){if(!p.exists("else")&&p.exists("skip"))break;p.exists("else")&&p.unset("else");if(p.exists("loop")){f+=v;break}if(t.length<1){if(b.debug)throw new Error("No arguments supplied for if statement")}else if(t.length===1){if(!k(t[0],c)){p.set("else"),p.set("skip");break}}else n(b,t,c)?p.unset("skip"):(p.set("else"),p.set("skip"))}else if(s==="else")p.exists("else")?p.unset("skip"):p.exists("skip")||p.set("skip");else if(s==="endif"){if(p.exists("loop")){f+=v;break}p.unset("skip")}else if(s==="each"){if(p.exists("skip"))break;if(p.exists("loop")){p.set("loop"),f+=v;break}p.set("loop");if(t.length<1){if(b.debug)throw new Error("No arguments supplied for each statement")}else Array.isArray(c[t[0]])?(g={},a=c[t[0]],g.index=t[2],f=""):(g={},c[t[0]]&&(a=c[t[0]],g.obj=t[0],g.key=t[2],g.val=t[3],f=""))}else if(s==="endeach"){if(p.exists("skip"))break;p.unset("loop");if(!p.exists("loop"))Array.isArray(a)?q.execArray(b,a,g,c):q.execObj(b,a,g,c),q.clear();else if(p.exists("loop")){f+=v+m.END_EXPR;break}}else if(s==="partial"){if(p.exists("skip"))break;if(p.exists("loop")){f+=v;break}r=v.split(" "),s=r.shift(),t=r,a=o(b,s,t,a,p),p.set("partial"),p.set("expr")}}else{if(p.exists("skip"))break;if(p.exists("loop")){f+=v;break}i+=v}break;case"WHITESPACE":if(p.exists("skip"))break;if(p.exists("loop")){f+=v;break}i+=v;break;case"FILTER":if(p.exists("skip"))break;if(p.exists("loop")){f+=v;break}p.unset("prop"),p.set("filter");break;case"COMMENT":if(p.exists("skip")){a="--";break}if(p.exists("loop")){f+=v;break}p.exists("expr")?p.set("skip"):i+=m.COMMENT}if(d.length)return e(b,c,d,m);j=i,p.clear(),i="",a=undefined;return j}}(),f=function(){function b(b){return b.replace(a,"\\$&")}var a=/[\^$\\\/.*+?()[\]{}|]/g;return function(a,c,f,g){var h,i,j,k,l,m,n,o=0,p=[],q={};i=b(g.START_PROP),j=b(g.END_PROP),k=b(g.START_EXPR),l=b(g.END_EXPR),m=b(g.COMMENT),n=b(g.FILTER),q.START_PROP=RegExp("^"+i),q.END_PROP=RegExp("^"+j),q.START_EXPR=RegExp("^"+k),q.END_EXPR=RegExp("^"+l),q.COMMENT=RegExp("^"+m),q.FILTER=RegExp("^"+n),h=[i,j,k,l,m,n].join("|"),q.WHITESPACE=/^[\ |\t|\r|\n]+/,q.OTHER=RegExp("^((?!"+h+").)*");if(o=d(c,p,q))if(a.debug)throw new Error(o);p.reverse();return e(a,f,p,g)}}();g.version="0.1.4",g.prototype={render:function(){var a=this;if(!a.template||!a.context)if(a.debug)throw new Error("Missing template or context");a.delimiters=a.delimiters||{},a.delimiters=b(a.delimiters,{START_PROP:"{{",END_PROP:"}}",START_EXPR:"{%",END_EXPR:"%}",COMMENT:"--",FILTER:"|"});return f(a,a.template,a.context,a.delimiters)},delimiters:{}},typeof module!="undefined"&&module.exports?(module.exports=g,module.exports.compile=function(a){return function(b){return g(a,b).render()}}):a.combyne=g})(this)